name: Release - Build and Publish

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.1)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  # Run tests before building release
  run-tests:
    name: Run Tests Before Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Go tests
      run: |
        go test -v -coverprofile=coverage.out ./...
        go tool cover -func=coverage.out | tail -1

    - name: Run Python tests
      run: pytest tests/ -v --tb=short || echo "Some tests may require display"
      continue-on-error: true

  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    needs: run-tests
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      release_notes: ${{ steps.release_notes.outputs.notes }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Extract release notes
      id: release_notes
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        VERSION_NUM="${VERSION#v}"
        if [ -f CHANGELOG.md ]; then
          awk "/## \[$VERSION_NUM\]/,/## \[/" CHANGELOG.md | sed '/## \['"$VERSION_NUM"'\]/d' | sed '/## \[/Q' | head -n -1 > /tmp/release_notes.md
          if [ ! -s /tmp/release_notes.md ]; then cp CHANGELOG.md /tmp/release_notes.md; fi
        else
          git log --pretty=format:"- %s (%h)" $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")..HEAD >> /tmp/release_notes.md
        fi

    - name: Upload release notes
      uses: actions/upload-artifact@v4
      with:
        name: release-notes
        path: /tmp/release_notes.md
        retention-days: 1

  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    needs: prepare-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Build Go sidecar
      run: |
        go mod download
        go build -v -ldflags="-s -w" -o uploader.exe uploader.go

    - name: Verify Go sidecar
      run: |
        if (!(Test-Path "uploader.exe")) { Write-Error "uploader.exe missing!"; exit 1 }
        $size = (Get-Item "uploader.exe").length
        Write-Output "✅ Go sidecar built: $([math]::Round($size / 1MB, 2)) MB"
        # Verify it's not empty (should be > 5MB)
        if ($size -lt 5000000) { Write-Error "uploader.exe is too small/empty!"; exit 1 }
      shell: pwsh

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # FIX: Generate a .spec file to avoid PowerShell argument parsing issues with semicolons
    - name: Create PyInstaller Spec
      run: |
        pyi-makespec --noconsole --onefile --clean --name "ConniesUploader" `
          --icon "logo.ico" `
          --add-binary "uploader.exe;." `
          --add-data "logo.ico;." `
          --collect-all tkinterdnd2 `
          main.py
      shell: pwsh

    - name: Build from Spec
      run: |
        pyinstaller ConniesUploader.spec

    - name: Verify build and bundling
      run: |
        if (!(Test-Path "dist\ConniesUploader.exe")) { Write-Error "Build failed"; exit 1 }
        $size = (Get-Item "dist\ConniesUploader.exe").length
        $sizeMB = [math]::Round($size / 1MB, 2)
        Write-Output "Build size: $sizeMB MB"
        
        # Increased threshold to 45MB to be safe
        if ($size -lt 45000000) {
          Write-Error "❌ Build size is only ${sizeMB} MB. Sidecar likely missing!"
          exit 1
        }
      shell: pwsh

    - name: Calculate checksums
      run: |
        cd dist
        $hash = (Get-FileHash -Algorithm SHA256 "ConniesUploader.exe").Hash
        $hash | Out-File -FilePath "ConniesUploader.exe.sha256" -Encoding ascii -NoNewline
        Write-Output "SHA256_WINDOWS=$hash" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Create ZIP package
      run: |
        cd dist
        Compress-Archive -Path "ConniesUploader.exe","ConniesUploader.exe.sha256" -DestinationPath "ConniesUploader-${{ needs.prepare-release.outputs.version }}-windows-x64.zip"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: |
          dist/ConniesUploader.exe
          dist/ConniesUploader.exe.sha256
          dist/ConniesUploader-${{ needs.prepare-release.outputs.version }}-windows-x64.zip

  build-linux:
    name: Build Linux Release
    runs-on: ubuntu-latest
    needs: prepare-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Build Go sidecar
      run: |
        go mod download
        go build -v -ldflags="-s -w" -o uploader uploader.go

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with PyInstaller
      run: |
        pyinstaller --noconsole --onefile --clean --name "ConniesUploader" \
          --add-binary "uploader:." \
          --add-data "logo.ico:." \
          --collect-all tkinterdnd2 \
          main.py

    - name: Calculate checksums
      run: |
        cd dist
        sha256sum ConniesUploader > ConniesUploader.sha256

    - name: Create tarball
      run: |
        cd dist
        tar -czf ConniesUploader-${{ needs.prepare-release.outputs.version }}-linux-x64.tar.gz ConniesUploader ConniesUploader.sha256

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: |
          dist/ConniesUploader
          dist/ConniesUploader.sha256
          dist/ConniesUploader-${{ needs.prepare-release.outputs.version }}-linux-x64.tar.gz

  build-macos:
    name: Build macOS Release
    runs-on: macos-latest
    needs: prepare-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Build Go sidecar
      run: |
        go mod download
        go build -v -ldflags="-s -w" -o uploader uploader.go

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with PyInstaller
      run: |
        pyinstaller --noconsole --onefile --clean --name "ConniesUploader" \
          --add-binary "uploader:." \
          --add-data "logo.ico:." \
          --collect-all tkinterdnd2 \
          main.py

    - name: Calculate checksums
      run: |
        cd dist
        shasum -a 256 ConniesUploader > ConniesUploader.sha256

    - name: Create ZIP package
      run: |
        cd dist
        zip -r ConniesUploader-${{ needs.prepare-release.outputs.version }}-macos-x64.zip ConniesUploader ConniesUploader.sha256

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: |
          dist/ConniesUploader
          dist/ConniesUploader.sha256
          dist/ConniesUploader-${{ needs.prepare-release.outputs.version }}-macos-x64.zip

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-windows, build-linux, build-macos]
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Download release notes
      uses: actions/download-artifact@v4
      with:
        name: release-notes
        path: .

    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        cp artifacts/windows-build/ConniesUploader.exe release-assets/
        cp artifacts/windows-build/ConniesUploader.exe.sha256 release-assets/
        cp artifacts/windows-build/ConniesUploader-*-windows-x64.zip release-assets/
        cp artifacts/linux-build/ConniesUploader release-assets/ConniesUploader-linux
        cp artifacts/linux-build/ConniesUploader.sha256 release-assets/ConniesUploader-linux.sha256
        cp artifacts/linux-build/ConniesUploader-*-linux-x64.tar.gz release-assets/
        cp artifacts/macos-build/ConniesUploader release-assets/ConniesUploader-macos
        cp artifacts/macos-build/ConniesUploader.sha256 release-assets/ConniesUploader-macos.sha256
        cp artifacts/macos-build/ConniesUploader-*-macos-x64.zip release-assets/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.prepare-release.outputs.version }}
        name: "Connie's Uploader ${{ needs.prepare-release.outputs.version }}"
        body_path: release_notes.md
        files: release-assets/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
