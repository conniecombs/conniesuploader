name: Release - Build and Publish

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.1)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      release_notes: ${{ steps.release_notes.outputs.notes }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Extract release notes from CHANGELOG
      id: release_notes
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        VERSION_NUM="${VERSION#v}"

        if [ -f CHANGELOG.md ]; then
          echo "Extracting release notes for version $VERSION_NUM from CHANGELOG.md"

          # Extract content between this version and next version marker
          awk "/## \[$VERSION_NUM\]/,/## \[/" CHANGELOG.md | \
            sed '/## \['"$VERSION_NUM"'\]/d' | \
            sed '/## \[/Q' | \
            head -n -1 > /tmp/release_notes.md

          # If extraction failed or empty, use full changelog
          if [ ! -s /tmp/release_notes.md ]; then
            echo "Could not extract specific version notes, using full changelog"
            cp CHANGELOG.md /tmp/release_notes.md
          fi
        else
          echo "No CHANGELOG.md found, generating from git log"
          echo "## What's Changed" > /tmp/release_notes.md
          echo "" >> /tmp/release_notes.md
          git log --pretty=format:"- %s (%h)" $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")..HEAD >> /tmp/release_notes.md
        fi

        # Store for output
        cat /tmp/release_notes.md

    - name: Upload release notes
      uses: actions/upload-artifact@v4
      with:
        name: release-notes
        path: /tmp/release_notes.md
        retention-days: 1

  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    needs: prepare-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Build Go sidecar
      run: |
        go mod download
        go build -v -ldflags="-s -w" -o uploader.exe uploader.go

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with PyInstaller
      run: |
        pyinstaller --noconsole --onefile --clean --name "ConniesUploader" `
          --icon "logo.ico" `
          --add-data "uploader.exe;." `
          --add-data "logo.ico;." `
          --collect-all tkinterdnd2 `
          main.py

    - name: Verify build
      run: |
        if (!(Test-Path "dist\ConniesUploader.exe")) {
          Write-Error "Build failed - ConniesUploader.exe not found"
          exit 1
        }
        $size = (Get-Item "dist\ConniesUploader.exe").length
        $sizeMB = [math]::Round($size / 1MB, 2)
        Write-Output "Build size: $sizeMB MB ($size bytes)"
        if ($size -lt 40000000) {
          Write-Warning "⚠️ Build size is ${sizeMB} MB (expected 40-50 MB)"
          Write-Warning "Sidecar may not be properly bundled - continuing anyway"
        } else {
          Write-Output "✅ Build size OK ($sizeMB MB)"
        }
      shell: pwsh

    - name: Calculate checksums
      run: |
        cd dist
        $hash = (Get-FileHash -Algorithm SHA256 "ConniesUploader.exe").Hash
        $hash | Out-File -FilePath "ConniesUploader.exe.sha256" -Encoding ascii -NoNewline
        Write-Output "SHA256: $hash"
        Write-Output "SHA256_WINDOWS=$hash" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Create ZIP package
      run: |
        cd dist
        Compress-Archive -Path "ConniesUploader.exe","ConniesUploader.exe.sha256" -DestinationPath "ConniesUploader-${{ needs.prepare-release.outputs.version }}-windows-x64.zip"
      shell: pwsh

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: |
          dist/ConniesUploader.exe
          dist/ConniesUploader.exe.sha256
          dist/ConniesUploader-${{ needs.prepare-release.outputs.version }}-windows-x64.zip
        retention-days: 5

  build-linux:
    name: Build Linux Release
    runs-on: ubuntu-latest
    needs: prepare-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Build Go sidecar
      run: |
        go mod download
        go build -v -ldflags="-s -w" -o uploader uploader.go

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with PyInstaller
      run: |
        pyinstaller --noconsole --onefile --clean --name "ConniesUploader" \
          --add-data "uploader:." \
          --add-data "logo.ico:." \
          --collect-all tkinterdnd2 \
          main.py

    - name: Verify build
      run: |
        if [ ! -f "dist/ConniesUploader" ]; then
          echo "Build failed - ConniesUploader not found"
          exit 1
        fi
        size=$(stat -f%z "dist/ConniesUploader" 2>/dev/null || stat -c%s "dist/ConniesUploader")
        echo "Build size: $size bytes"

    - name: Calculate checksums
      run: |
        cd dist
        sha256sum ConniesUploader > ConniesUploader.sha256
        cat ConniesUploader.sha256

    - name: Create tarball
      run: |
        cd dist
        tar -czf ConniesUploader-${{ needs.prepare-release.outputs.version }}-linux-x64.tar.gz ConniesUploader ConniesUploader.sha256

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: |
          dist/ConniesUploader
          dist/ConniesUploader.sha256
          dist/ConniesUploader-${{ needs.prepare-release.outputs.version }}-linux-x64.tar.gz
        retention-days: 5

  build-macos:
    name: Build macOS Release
    runs-on: macos-latest
    needs: prepare-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Build Go sidecar
      run: |
        go mod download
        go build -v -ldflags="-s -w" -o uploader uploader.go

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with PyInstaller
      run: |
        pyinstaller --noconsole --onefile --clean --name "ConniesUploader" \
          --add-data "uploader:." \
          --add-data "logo.ico:." \
          --collect-all tkinterdnd2 \
          main.py

    - name: Verify build
      run: |
        if [ ! -f "dist/ConniesUploader" ]; then
          echo "Build failed - ConniesUploader not found"
          exit 1
        fi
        size=$(stat -f%z "dist/ConniesUploader")
        echo "Build size: $size bytes"

    - name: Calculate checksums
      run: |
        cd dist
        shasum -a 256 ConniesUploader > ConniesUploader.sha256
        cat ConniesUploader.sha256

    - name: Create ZIP package
      run: |
        cd dist
        zip -r ConniesUploader-${{ needs.prepare-release.outputs.version }}-macos-x64.zip ConniesUploader ConniesUploader.sha256

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: |
          dist/ConniesUploader
          dist/ConniesUploader.sha256
          dist/ConniesUploader-${{ needs.prepare-release.outputs.version }}-macos-x64.zip
        retention-days: 5

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-windows, build-linux, build-macos]
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Download release notes
      uses: actions/download-artifact@v4
      with:
        name: release-notes
        path: .

    - name: Display structure of downloaded files
      run: ls -R artifacts/

    - name: Prepare release assets
      run: |
        mkdir -p release-assets

        # Windows
        cp artifacts/windows-build/ConniesUploader.exe release-assets/
        cp artifacts/windows-build/ConniesUploader.exe.sha256 release-assets/
        cp artifacts/windows-build/ConniesUploader-${{ needs.prepare-release.outputs.version }}-windows-x64.zip release-assets/

        # Linux
        cp artifacts/linux-build/ConniesUploader release-assets/ConniesUploader-linux
        cp artifacts/linux-build/ConniesUploader.sha256 release-assets/ConniesUploader-linux.sha256
        cp artifacts/linux-build/ConniesUploader-${{ needs.prepare-release.outputs.version }}-linux-x64.tar.gz release-assets/

        # macOS
        cp artifacts/macos-build/ConniesUploader release-assets/ConniesUploader-macos
        cp artifacts/macos-build/ConniesUploader.sha256 release-assets/ConniesUploader-macos.sha256
        cp artifacts/macos-build/ConniesUploader-${{ needs.prepare-release.outputs.version }}-macos-x64.zip release-assets/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.prepare-release.outputs.version }}
        name: "Connie's Uploader ${{ needs.prepare-release.outputs.version }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          release-assets/ConniesUploader.exe
          release-assets/ConniesUploader.exe.sha256
          release-assets/ConniesUploader-${{ needs.prepare-release.outputs.version }}-windows-x64.zip
          release-assets/ConniesUploader-${{ needs.prepare-release.outputs.version }}-linux-x64.tar.gz
          release-assets/ConniesUploader-${{ needs.prepare-release.outputs.version }}-macos-x64.zip
          CHANGELOG.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
